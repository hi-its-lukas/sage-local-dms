{% extends 'dms/base.html' %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block sub_header %}
<div class="sub-header">
    <span class="sub-header-title">Übersicht</span>
    <button id="toggle-edit-mode" class="btn btn-sm" style="margin-left: auto;">
        <span class="material-icons" style="font-size: 18px; vertical-align: middle;">edit</span>
        Anpassen
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .widget.sortable-ghost { opacity: 0.4; }
    .widget.sortable-chosen { box-shadow: 0 8px 25px rgba(0,0,0,0.15); transform: scale(1.02); }
    .widget.sortable-drag { cursor: grabbing; }
    .edit-mode .widget { cursor: grab; }
    .edit-mode .widget:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .edit-mode .widget-header::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 4px;
        background: var(--primary);
        border-radius: var(--radius-md) var(--radius-md) 0 0;
    }
    .edit-mode .widget { position: relative; }
    .drag-handle { display: none; position: absolute; top: 8px; right: 8px; color: var(--text-muted); cursor: grab; }
    .edit-mode .drag-handle { display: block; }
    .sub-header { display: flex; align-items: center; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .edit-mode-active { background: var(--primary) !important; color: white !important; }
</style>
{% endblock %}

{% block content %}
<div class="widget-grid" id="widget-grid">
    <div class="widget" data-widget-id="search">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon blue">
                <span class="material-icons">search</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Suche</div>
                <div class="widget-subtitle">Suche nach Dokumenten, E-Mails oder Akten</div>
            </div>
        </div>
        <div class="widget-body">
            <form action="{% url 'dms:document_list' %}" method="get">
                <div class="search-input-wrapper">
                    <span class="material-icons search-input-icon">search</span>
                    <input type="text" name="search" class="search-input" placeholder="Was möchten Sie finden?">
                </div>
            </form>
            <a href="{% url 'dms:document_list' %}" class="search-link">Erweiterte Suche</a>
        </div>
    </div>
    
    <div class="widget" data-widget-id="import">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon green">
                <span class="material-icons">upload_file</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Import</div>
                <div class="widget-subtitle">Dokumente importieren und mehr</div>
            </div>
        </div>
        <div class="widget-body">
            <form id="dashboard-upload-form" action="{% url 'dms:upload_file' %}" method="post" enctype="multipart/form-data" style="display: none;">
                {% csrf_token %}
                <input type="file" id="dashboard-file-input" name="file" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.tif,.tiff">
            </form>
            <div id="upload-zone" class="upload-zone" onclick="document.getElementById('dashboard-file-input').click();">
                <span class="material-icons" id="upload-icon">cloud_upload</span>
                <div class="upload-zone-text" id="upload-text">
                    Drag & Drop. <span class="upload-zone-link">Alternativ hier klicken zum Hochladen.</span>
                </div>
                <div id="upload-progress" style="display: none; width: 100%;">
                    <div class="progress-bar-container" style="background: var(--bg-hover); border-radius: 4px; height: 8px; margin-top: 8px;">
                        <div id="upload-progress-bar" style="background: var(--success); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="upload-status" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="widget" data-widget-id="tasks">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon orange">
                <span class="material-icons">checklist</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Aufgaben</div>
                <div class="widget-subtitle">Erledigen von ausstehenden Aufgaben</div>
            </div>
        </div>
        <div class="widget-body">
            {% if open_tasks %}
            <ul class="recent-list">
                {% for task in open_tasks|slice:":5" %}
                <li class="recent-item">
                    <span class="material-icons recent-item-icon" style="color: {% if task.priority == 'HIGH' %}var(--error){% elif task.priority == 'MEDIUM' %}var(--warning){% else %}var(--primary){% endif %}">assignment</span>
                    <div class="recent-item-content">
                        <div class="recent-item-title">{{ task.title }}</div>
                        <div class="recent-item-date">{{ task.get_priority_display }}</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="task-empty">
                <svg width="100" height="70" viewBox="0 0 100 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <ellipse cx="50" cy="65" rx="40" ry="5" fill="#e2e8f0"/>
                    <path d="M30 65V35c0-5 5-10 10-15s10-10 10-20" stroke="#3182ce" stroke-width="4" fill="none"/>
                    <circle cx="50" cy="15" r="10" fill="#3182ce"/>
                    <path d="M50 65V40c0-5 5-10 10-15" stroke="#38b2ac" stroke-width="3" fill="none"/>
                    <circle cx="60" cy="25" r="7" fill="#38b2ac"/>
                    <path d="M70 65V45c0-3 3-6 5-10" stroke="#718096" stroke-width="2" fill="none"/>
                    <circle cx="75" cy="35" r="5" fill="#718096"/>
                </svg>
                <div class="task-empty-text">Liste hat keine Einträge</div>
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">Möchten Sie die Liste erneut laden?</div>
                <a href="" class="task-refresh-link">AKTUALISIEREN</a>
            </div>
            {% endif %}
        </div>
        <a href="{% url 'dms:task_list' %}" class="task-create-link">Aufgaben anzeigen</a>
    </div>
    
    <div class="widget" data-widget-id="recent">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon teal">
                <span class="material-icons">schedule</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Zuletzt bearbeitet</div>
                <div class="widget-subtitle">Anzeigen Ihrer zuletzt bearbeiteten Elemente</div>
            </div>
        </div>
        <div class="widget-body">
            {% if recent_documents %}
            <ul class="recent-list">
                {% for doc in recent_documents|slice:":6" %}
                <a href="{% url 'dms:document_detail' doc.pk %}" class="recent-item">
                    <span class="material-icons recent-item-icon">{% if doc.mime_type == 'application/pdf' %}picture_as_pdf{% else %}description{% endif %}</span>
                    <div class="recent-item-content">
                        <div class="recent-item-title">{{ doc.title|truncatechars:40 }}</div>
                        <div class="recent-item-date">{{ doc.updated_at|date:"d.m.Y H:i:s" }}</div>
                    </div>
                </a>
                {% endfor %}
            </ul>
            {% else %}
            <div class="task-empty">
                <span class="material-icons" style="font-size: 48px; color: var(--text-muted);">history</span>
                <div class="task-empty-text" style="margin-top: 12px;">Keine kürzlich bearbeiteten Dokumente</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="widget" data-widget-id="scan">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon purple">
                <span class="material-icons">document_scanner</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Scannen</div>
                <div class="widget-subtitle">Scannen von Dokumenten</div>
            </div>
        </div>
        <div class="widget-body compact">
            {% if active_scans %}
            <div class="scan-status-active" style="background: var(--info-bg); border: 1px solid var(--info); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 12px;">
                {% for scan in active_scans %}
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span class="material-icons" style="color: var(--info); animation: spin 1s linear infinite;">sync</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: var(--info);">{{ scan.get_source_display }} läuft...</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">{{ scan.processed_files }} / {{ scan.total_files }} Dateien ({{ scan.progress_percent }}%)</div>
                    </div>
                </div>
                <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                    <div style="background: var(--info); height: 100%; width: {{ scan.progress_percent }}%; transition: width 0.5s;"></div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <a href="{% url 'dms:sage_sync_dashboard' %}" class="menu-link">
                <span class="material-icons">sync</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Sage-Archiv scannen</div>
                    <div class="menu-link-desc">Import aus dem Sage-Archivordner starten</div>
                </div>
            </a>
        </div>
    </div>
    
    <div class="widget" data-widget-id="config">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon gray">
                <span class="material-icons">settings</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Konfiguration</div>
                <div class="widget-subtitle">Übersicht aller Konfigurationen</div>
            </div>
        </div>
        <div class="widget-body compact">
            <a href="{% url 'admin:index' %}" class="menu-link">
                <span class="material-icons">admin_panel_settings</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Administration</div>
                    <div class="menu-link-desc">Systemeinstellungen verwalten</div>
                </div>
            </a>
            <a href="{% url 'dms:sage_sync_dashboard' %}" class="menu-link">
                <span class="material-icons">cloud_sync</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Sage Cloud</div>
                    <div class="menu-link-desc">Sage HR Cloud Synchronisation</div>
                </div>
            </a>
            <a href="{% url 'dms:system_logs' %}" class="menu-link">
                <span class="material-icons">terminal</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Systemprotokoll</div>
                    <div class="menu-link-desc">Live-Logs und Debugging</div>
                </div>
            </a>
        </div>
    </div>
    
    <div class="widget" data-widget-id="files">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon blue">
                <span class="material-icons">create_new_folder</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Aktenerstellung</div>
                <div class="widget-subtitle">Neue Akten zur Verfügung stellen</div>
            </div>
        </div>
        <div class="widget-body compact">
            <a href="{% url 'dms:personnel_file_list' %}" class="menu-link">
                <span class="material-icons">folder_shared</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Personalakten</div>
                    <div class="menu-link-desc">Personalakten verwalten und erstellen</div>
                </div>
            </a>
            <a href="{% url 'dms:employee_list' %}" class="menu-link">
                <span class="material-icons">people</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Mitarbeiter</div>
                    <div class="menu-link-desc">Mitarbeiterliste anzeigen</div>
                </div>
            </a>
        </div>
    </div>
    
    <div class="widget" data-widget-id="filing">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon green">
                <span class="material-icons">add_circle</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Ablage</div>
                <div class="widget-subtitle">Neue Inhalte zur Verfügung stellen</div>
            </div>
        </div>
        <div class="widget-body compact">
            <a href="{% url 'dms:upload_page' %}" class="menu-link">
                <span class="material-icons">upload_file</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Dokument hochladen</div>
                    <div class="menu-link-desc">Neue Dokumente im System ablegen</div>
                </div>
            </a>
            <a href="{% url 'dms:filing_plan' %}" class="menu-link">
                <span class="material-icons">account_tree</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Aktenplan</div>
                    <div class="menu-link-desc">Kategorien und Aufbewahrungsfristen</div>
                </div>
            </a>
        </div>
    </div>
    
    <div class="widget" data-widget-id="help">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-header">
            <div class="widget-icon purple">
                <span class="material-icons">help_outline</span>
            </div>
            <div class="widget-title-group">
                <div class="widget-title">Hilfe</div>
            </div>
        </div>
        <div class="widget-body compact">
            <a href="{% url 'admin:dms_systemsettings_changelist' %}" class="menu-link">
                <span class="material-icons">settings</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Systemeinstellungen</div>
                    <div class="menu-link-desc">Alle Systemkonfigurationen</div>
                </div>
            </a>
            <a href="{% url 'admin:index' %}" class="menu-link">
                <span class="material-icons">support</span>
                <div class="menu-link-content">
                    <div class="menu-link-title">Administration</div>
                    <div class="menu-link-desc">Django Admin-Bereich</div>
                </div>
            </a>
        </div>
    </div>
</div>

{% if active_scans %}
<div class="card" style="margin-top: 24px;">
    <h2 style="display: flex; align-items: center; gap: 8px;">
        <span class="material-icons" style="animation: spin 2s linear infinite;">sync</span>
        Aktive Verarbeitung
    </h2>
    {% for scan in active_scans %}
    <div style="padding: 16px; background: var(--bg-page); border-radius: var(--radius-md); margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 500;">{{ scan.get_source_display }}</span>
            <span style="color: var(--text-secondary);">{{ scan.progress_percent }}%</span>
        </div>
        <div style="background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: var(--primary); height: 100%; width: {{ scan.progress_percent }}%; transition: width 0.5s;"></div>
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
            {{ scan.processed_files }} von {{ scan.total_files }} neue Dateien
            {% if scan.skipped_files %} ({{ scan.skipped_files }} bereits vorhanden){% endif %}
            {% if scan.current_file %} | Aktuell: {{ scan.current_file|truncatechars:40 }}{% endif %}
        </div>
    </div>
    {% endfor %}
</div>
<style>
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
{% endif %}

{% if recent_scans %}
<div class="card" style="margin-top: 24px;">
    <h2>Letzte Scan-Aufträge</h2>
    <table style="margin-top: 16px;">
        <thead>
            <tr>
                <th>Quelle</th>
                <th>Status</th>
                <th>Neu verarbeitet</th>
                <th>Bereits vorhanden</th>
                <th>Fehler</th>
                <th>Datum</th>
            </tr>
        </thead>
        <tbody>
            {% for scan in recent_scans %}
            <tr>
                <td>{{ scan.get_source_display }}</td>
                <td>
                    <span class="badge {% if scan.status == 'COMPLETED' %}badge-success{% elif scan.status == 'FAILED' %}badge-error{% else %}badge-warning{% endif %}">
                        {{ scan.get_status_display }}
                    </span>
                </td>
                <td>{{ scan.processed_files }}</td>
                <td>{{ scan.skipped_files }}</td>
                <td>{{ scan.error_files }}</td>
                <td>{{ scan.started_at|date:"d.m.Y H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="stats" style="margin-top: 24px;">
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-card-icon">
                <span class="material-icons">description</span>
            </div>
        </div>
        <h3>{{ stats.total_documents }}</h3>
        <p>Dokumente gesamt</p>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-card-icon" style="background: var(--warning-bg); color: var(--warning);">
                <span class="material-icons">help_outline</span>
            </div>
        </div>
        <h3>{{ stats.unassigned }}</h3>
        <p>Nicht zugewiesen</p>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-card-icon" style="background: var(--error-bg); color: var(--error);">
                <span class="material-icons">warning</span>
            </div>
        </div>
        <h3>{{ stats.review_needed }}</h3>
        <p>Prüfung erforderlich</p>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-card-icon" style="background: var(--success-bg); color: var(--success);">
                <span class="material-icons">folder_shared</span>
            </div>
        </div>
        <h3>{{ stats.total_personnel_files|default:"0" }}</h3>
        <p>Personalakten</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('dashboard-file-input');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadStatus = document.getElementById('upload-status');
    const uploadIcon = document.getElementById('upload-icon');
    const uploadText = document.getElementById('upload-text');
    
    if (!uploadZone) return;

    // Drag & Drop Events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        uploadZone.style.borderColor = 'var(--primary)';
        uploadZone.style.background = 'var(--primary-light)';
    }

    function unhighlight(e) {
        uploadZone.style.borderColor = '';
        uploadZone.style.background = '';
    }

    // Drop-Handler
    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // File Input Change
    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        if (files.length === 0) return;
        
        uploadText.style.display = 'none';
        uploadProgress.style.display = 'block';
        uploadIcon.textContent = 'hourglass_empty';
        
        let uploaded = 0;
        const total = files.length;
        
        Array.from(files).forEach(file => {
            uploadFile(file, () => {
                uploaded++;
                const percent = Math.round((uploaded / total) * 100);
                uploadProgressBar.style.width = percent + '%';
                uploadStatus.textContent = `${uploaded} von ${total} Datei(en) hochgeladen`;
                
                if (uploaded === total) {
                    setTimeout(() => {
                        uploadIcon.textContent = 'check_circle';
                        uploadIcon.style.color = 'var(--success)';
                        uploadStatus.textContent = 'Upload abgeschlossen!';
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }, 500);
                }
            }, (error) => {
                uploadIcon.textContent = 'error';
                uploadIcon.style.color = 'var(--error)';
                uploadStatus.textContent = 'Fehler: ' + error;
            });
        });
    }

    function uploadFile(file, onSuccess, onError) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "dms:upload_file" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                onSuccess();
            } else {
                onError(data.error || 'Upload fehlgeschlagen');
            }
        })
        .catch(error => {
            onError('Netzwerkfehler');
        });
    }

    // Menu-Button (App Grid) Toggle
    const appGridBtn = document.querySelector('.app-grid-btn');
    if (appGridBtn) {
        appGridBtn.addEventListener('click', function() {
            window.location.href = '{% url "dms:index" %}';
        });
    }
    
    // Widget Drag & Drop
    const widgetGrid = document.getElementById('widget-grid');
    const toggleEditBtn = document.getElementById('toggle-edit-mode');
    let sortableInstance = null;
    let isEditMode = false;
    
    // Load saved order
    function loadWidgetOrder() {
        const savedOrder = localStorage.getItem('dms_widget_order');
        if (savedOrder) {
            try {
                const order = JSON.parse(savedOrder);
                const widgets = Array.from(widgetGrid.querySelectorAll('.widget'));
                const widgetMap = {};
                widgets.forEach(w => {
                    widgetMap[w.dataset.widgetId] = w;
                });
                order.forEach(id => {
                    if (widgetMap[id]) {
                        widgetGrid.appendChild(widgetMap[id]);
                    }
                });
            } catch (e) {
                console.log('Could not load widget order');
            }
        }
    }
    
    // Save order
    function saveWidgetOrder() {
        const widgets = Array.from(widgetGrid.querySelectorAll('.widget'));
        const order = widgets.map(w => w.dataset.widgetId);
        localStorage.setItem('dms_widget_order', JSON.stringify(order));
    }
    
    // Toggle edit mode
    toggleEditBtn.addEventListener('click', function() {
        isEditMode = !isEditMode;
        widgetGrid.classList.toggle('edit-mode', isEditMode);
        toggleEditBtn.classList.toggle('edit-mode-active', isEditMode);
        toggleEditBtn.innerHTML = isEditMode 
            ? '<span class="material-icons" style="font-size: 18px; vertical-align: middle;">check</span> Fertig'
            : '<span class="material-icons" style="font-size: 18px; vertical-align: middle;">edit</span> Anpassen';
        
        if (isEditMode) {
            initSortable();
        } else {
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
        }
    });
    
    function initSortable() {
        if (typeof Sortable !== 'undefined') {
            sortableInstance = new Sortable(widgetGrid, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function() {
                    saveWidgetOrder();
                }
            });
        }
    }
    
    // Load order on page load
    loadWidgetOrder();
});

// Load SortableJS dynamically
const sortableScript = document.createElement('script');
sortableScript.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js';
document.head.appendChild(sortableScript);
</script>
{% endblock %}
