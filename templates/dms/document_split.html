{% extends "dms/base.html" %}
{% load static %}

{% block title %}Dokument teilen - {{ document.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dms:index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'dms:document_list' %}">Dokumente</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'dms:document_detail' document.pk %}">{{ document.title|truncatechars:30 }}</a></li>
                    <li class="breadcrumb-item active">Teilen</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-scissors"></i> 
                        Dokument manuell teilen
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>{{ document.original_filename }}</strong> hat {{ page_count }} Seiten.
                        Definieren Sie die Seitenbereiche und ordnen Sie diese den Mitarbeitern zu.
                    </div>

                    <form method="post" id="splitForm">
                        {% csrf_token %}
                        <input type="hidden" name="splits" id="splitsData" value="[]">

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h6>Seitenbereiche definieren</h6>
                                <table class="table table-bordered" id="splitsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 120px;">Von Seite</th>
                                            <th style="width: 120px;">Bis Seite</th>
                                            <th>Mitarbeiter</th>
                                            <th style="width: 80px;">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="splitsBody">
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addSplit">
                                    <i class="bi bi-plus"></i> Bereich hinzufügen
                                </button>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="bi bi-lightbulb"></i> Tipps</h6>
                                        <ul class="small mb-0">
                                            <li>Seiten beginnen bei 1</li>
                                            <li>Bereiche dürfen sich nicht überlappen</li>
                                            <li>Nicht zugeordnete Seiten werden verworfen</li>
                                            <li>Nach dem Teilen wird das Original gelöscht</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="bi bi-scissors"></i> Dokument teilen
                            </button>
                            <a href="{% url 'dms:document_detail' document.pk %}" class="btn btn-secondary">
                                Abbrechen
                            </a>
                            <a href="{% url 'dms:document_view' document.pk %}" class="btn btn-outline-info" target="_blank">
                                <i class="bi bi-eye"></i> PDF ansehen
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const pageCount = {{ page_count }};
const employees = [
    {% for emp in employees %}
    { id: "{{ emp.id }}", name: "{{ emp.full_name }} ({{ emp.employee_id }})" }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let splits = [];
let nextId = 1;

function renderSplits() {
    const tbody = document.getElementById('splitsBody');
    tbody.innerHTML = '';
    
    splits.forEach((split, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${split.start}" min="1" max="${pageCount}"
                       onchange="updateSplit(${index}, 'start', this.value)">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${split.end}" min="1" max="${pageCount}"
                       onchange="updateSplit(${index}, 'end', this.value)">
            </td>
            <td>
                <select class="form-select form-select-sm" onchange="updateSplit(${index}, 'employee_id', this.value)">
                    <option value="">-- Mitarbeiter wählen --</option>
                    ${employees.map(e => `<option value="${e.id}" ${split.employee_id === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                </select>
            </td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSplit(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateFormData();
}

function addSplit() {
    const lastEnd = splits.length > 0 ? splits[splits.length - 1].end : 0;
    splits.push({
        start: lastEnd + 1,
        end: Math.min(lastEnd + 1, pageCount),
        employee_id: ''
    });
    renderSplits();
}

function removeSplit(index) {
    splits.splice(index, 1);
    renderSplits();
}

function updateSplit(index, field, value) {
    if (field === 'start' || field === 'end') {
        splits[index][field] = parseInt(value) || 1;
    } else {
        splits[index][field] = value;
    }
    updateFormData();
}

function updateFormData() {
    document.getElementById('splitsData').value = JSON.stringify(splits);
    document.getElementById('submitBtn').disabled = splits.length === 0;
}

document.getElementById('addSplit').addEventListener('click', addSplit);

document.getElementById('splitForm').addEventListener('submit', function(e) {
    if (splits.length === 0) {
        e.preventDefault();
        alert('Bitte fügen Sie mindestens einen Seitenbereich hinzu.');
        return;
    }
    
    for (let split of splits) {
        if (split.start > split.end) {
            e.preventDefault();
            alert('Von-Seite muss kleiner oder gleich Bis-Seite sein.');
            return;
        }
        if (split.start < 1 || split.end > pageCount) {
            e.preventDefault();
            alert(`Seitenzahlen müssen zwischen 1 und ${pageCount} liegen.`);
            return;
        }
    }
    
    if (!confirm(`Das Dokument wird in ${splits.length} Teile aufgeteilt. Das Original wird danach gelöscht. Fortfahren?`)) {
        e.preventDefault();
    }
});

addSplit();
</script>
{% endblock %}
