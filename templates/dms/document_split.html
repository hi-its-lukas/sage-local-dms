{% extends "dms/base.html" %}
{% load static %}

{% block title %}Dokument teilen - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
    .split-container {
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .split-breadcrumb {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 20px;
    }
    
    .split-breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }
    
    .split-breadcrumb span {
        margin: 0 8px;
    }
    
    .split-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 24px;
    }
    
    @media (max-width: 1200px) {
        .split-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .split-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .split-card-header {
        background: var(--primary);
        color: white;
        padding: 16px 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .split-card-body {
        padding: 20px;
    }
    
    .split-info {
        background: var(--bg-page);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    
    .split-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
    }
    
    .split-table th {
        background: var(--bg-page);
        padding: 10px 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border);
    }
    
    .split-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
    }
    
    .split-table input,
    .split-table select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 14px;
    }
    
    .split-tips {
        background: var(--bg-page);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-top: 20px;
    }
    
    .split-tips h6 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
    }
    
    .split-tips ul {
        margin: 0;
        padding-left: 20px;
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .split-tips li {
        margin-bottom: 4px;
    }
    
    .split-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    .pdf-preview-panel {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .pdf-preview-header {
        background: var(--bg-page);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .pdf-preview-content {
        padding: 16px;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .page-thumbnails {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .page-thumb {
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        overflow: hidden;
        cursor: pointer;
        transition: border-color 0.2s;
        position: relative;
    }
    
    .page-thumb:hover {
        border-color: var(--primary);
    }
    
    .page-thumb.selected {
        border-color: var(--primary);
        background: var(--primary-light);
    }
    
    .page-thumb-number {
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--primary);
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .page-thumb-img {
        width: 100%;
        height: auto;
        min-height: 100px;
        background: var(--bg-page);
        display: block;
        object-fit: contain;
    }
    
    .page-thumb-label {
        padding: 8px;
        font-size: 12px;
        text-align: center;
        background: var(--bg-page);
    }
    
    .btn-remove {
        background: none;
        border: none;
        color: var(--error);
        cursor: pointer;
        padding: 4px;
    }
    
    .btn-remove:hover {
        background: var(--bg-hover);
        border-radius: var(--radius-sm);
    }
</style>
{% endblock %}

{% block content %}
<div class="split-container">
    <div class="split-breadcrumb">
        <a href="{% url 'dms:index' %}">Dashboard</a>
        <span>›</span>
        <a href="{% url 'dms:document_list' %}">Dokumente</a>
        <span>›</span>
        <a href="{% url 'dms:document_detail' document.pk %}">{{ document.title|truncatechars:30 }}</a>
        <span>›</span>
        Teilen
    </div>

    <div class="split-layout">
        <div class="split-card">
            <div class="split-card-header">
                <span class="material-icons">content_cut</span>
                Dokument manuell teilen
            </div>
            <div class="split-card-body">
                <div class="split-info">
                    <strong>{{ document.original_filename }}</strong> hat <strong>{{ page_count }} Seiten</strong>.
                    Definieren Sie die Seitenbereiche und ordnen Sie diese den Mitarbeitern zu.
                </div>

                <form method="post" id="splitForm">
                    {% csrf_token %}
                    <input type="hidden" name="splits" id="splitsData" value="[]">

                    <h6 style="margin-bottom: 12px; font-size: 14px;">Seitenbereiche definieren</h6>
                    <table class="split-table" id="splitsTable">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Von Seite</th>
                                <th style="width: 100px;">Bis Seite</th>
                                <th>Mitarbeiter</th>
                                <th style="width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="splitsBody">
                        </tbody>
                    </table>
                    
                    <button type="button" class="btn btn-outline" id="addSplit">
                        <span class="material-icons" style="font-size: 16px;">add</span>
                        Bereich hinzufügen
                    </button>

                    <div class="split-tips">
                        <h6><span class="material-icons" style="font-size: 16px; vertical-align: middle;">lightbulb</span> Tipps</h6>
                        <ul>
                            <li>Seiten beginnen bei 1</li>
                            <li>Bereiche dürfen sich nicht überlappen</li>
                            <li>Nicht zugeordnete Seiten werden verworfen</li>
                            <li>Nach dem Teilen wird das Original gelöscht</li>
                        </ul>
                    </div>

                    <div class="split-actions">
                        <button type="submit" class="btn" id="submitBtn" disabled>
                            <span class="material-icons" style="font-size: 16px;">content_cut</span>
                            Dokument teilen
                        </button>
                        <a href="{% url 'dms:document_detail' document.pk %}" class="btn btn-outline">
                            Abbrechen
                        </a>
                        <a href="{% url 'dms:document_view' document.pk %}" class="btn btn-outline" target="_blank">
                            <span class="material-icons" style="font-size: 16px;">open_in_new</span>
                            PDF in neuem Tab
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="pdf-preview-panel">
            <div class="pdf-preview-header">
                <span class="material-icons" style="font-size: 18px;">preview</span>
                Seitenübersicht ({{ page_count }} Seiten)
            </div>
            <div class="pdf-preview-content">
                <div class="page-thumbnails">
                    {% for page_num in page_range %}
                    <div class="page-thumb" data-page="{{ page_num }}">
                        <span class="page-thumb-number">{{ page_num }}</span>
                        <img class="page-thumb-img" 
                             src="{% url 'dms:document_page_thumbnail' document.pk page_num %}" 
                             alt="Seite {{ page_num }}"
                             loading="lazy">
                        <div class="page-thumb-label">Seite {{ page_num }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const pageCount = {{ page_count }};
const employees = [
    {% for emp in employees %}
    { id: "{{ emp.id }}", name: "{{ emp.full_name }} ({{ emp.employee_id }})" }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let splits = [];
let nextId = 1;

function renderSplits() {
    const tbody = document.getElementById('splitsBody');
    tbody.innerHTML = '';
    
    splits.forEach((split, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="number" value="${split.start}" min="1" max="${pageCount}"
                       onchange="updateSplit(${index}, 'start', this.value)">
            </td>
            <td>
                <input type="number" value="${split.end}" min="1" max="${pageCount}"
                       onchange="updateSplit(${index}, 'end', this.value)">
            </td>
            <td>
                <select onchange="updateSplit(${index}, 'employee_id', this.value)">
                    <option value="">-- Mitarbeiter wählen --</option>
                    ${employees.map(e => `<option value="${e.id}" ${split.employee_id === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                </select>
            </td>
            <td>
                <button type="button" class="btn-remove" onclick="removeSplit(${index})">
                    <span class="material-icons">delete</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateFormData();
    highlightPages();
}

function highlightPages() {
    document.querySelectorAll('.page-thumb').forEach(thumb => {
        thumb.classList.remove('selected');
    });
    
    splits.forEach(split => {
        for (let i = split.start; i <= split.end; i++) {
            const thumb = document.querySelector(`.page-thumb[data-page="${i}"]`);
            if (thumb) {
                thumb.classList.add('selected');
            }
        }
    });
}

function addSplit() {
    let startPage = 1;
    if (splits.length > 0) {
        const lastSplit = splits[splits.length - 1];
        startPage = Math.min(lastSplit.end + 1, pageCount);
    }
    
    splits.push({
        id: nextId++,
        start: startPage,
        end: startPage,
        employee_id: ''
    });
    renderSplits();
}

function removeSplit(index) {
    splits.splice(index, 1);
    renderSplits();
}

function updateSplit(index, field, value) {
    if (field === 'start' || field === 'end') {
        value = parseInt(value) || 1;
        value = Math.max(1, Math.min(value, pageCount));
    }
    splits[index][field] = value;
    
    if (field === 'start' && splits[index].end < splits[index].start) {
        splits[index].end = splits[index].start;
    }
    
    renderSplits();
}

function updateFormData() {
    document.getElementById('splitsData').value = JSON.stringify(splits);
    
    const hasValidSplits = splits.length > 0 && splits.some(s => s.start > 0 && s.end >= s.start);
    document.getElementById('submitBtn').disabled = !hasValidSplits;
}

document.getElementById('addSplit').addEventListener('click', addSplit);

addSplit();

document.querySelectorAll('.page-thumb').forEach(thumb => {
    thumb.addEventListener('click', function() {
        const pageNum = parseInt(this.dataset.page);
        if (splits.length === 0) {
            addSplit();
        }
        const lastSplit = splits[splits.length - 1];
        if (pageNum < lastSplit.start) {
            lastSplit.start = pageNum;
        }
        lastSplit.end = pageNum;
        renderSplits();
    });
});
</script>
{% endblock %}
